---
title: "LCA part of analysis"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
#------------------
# LOAD LIBRARIES
#------------------
 
library(readxl) #to read csv equipment list and exported data from OneClick
#load these last so their function names don't get overridden:
library(tidyverse) #for everything 
library(dplyr) #for everything 
```


```{r}
#------------------
# GET FILES
#------------------
 
files.lca <- 
    list.files(path = "./RawData_doNotUpload/LCAdat", # read all excel fileNAMES from the folder
                       pattern = "*.xls",
                       full.names = TRUE,
                       recursive = FALSE) %>% 
    tbl_df() %>% # make the list into a dataframe, default name of column is "value"
    rename(filenames = value)%>%
    mutate(myFiles = purrr::map(filenames, function(x) {  #for each filename, read in the file (gets nested)
        readxl::read_excel(x,
                           skip=2,
                           col_types = "text")})) %>% 
    unnest(myFiles) 
 

#------------------
# ORGANIZE DATA
#------------------ 
 
dat.lca <-
    files.lca %>%
    dplyr::select(c(2,6,10,11,14,16)) %>% # keep only columns of interest for this analysis
    rename(GWP= 'Global warming kg CO2e') %>% # name compliant
    rename(Lifespan= 'Service life')%>% # name compliant
    rename(ID=Comment) %>%  # this is the ID for the component that corresponds with spreadsheet naming convention
    na.omit() %>%  #this drops the rows with electricity which are irrelevant for this analysis
    mutate(GWP= as.numeric(GWP)) %>% #when the file is read it originally was converted to text, need it to be numeric 
    mutate(Lifespan = as.numeric(Lifespan)) %>%
    filter(Section!="D") %>% 
    filter(Section != "B4-B5")
  
#------------------
# ADD EXTRA INFORMATION
#------------------ 

dat.extra <- # this information was collected separately and manually
    data.frame("Name"=c("Heating motor","Reflective panel","Suction guide"),
               "ID"=c("mtr_1_siem","ref_3_mtx","suc_2_arm"),
                "GWP"=c(119.66,3.2536,129.80),
                "Lifespan"=c(18,10,20))

dat.all<- # combine dataframes 
    merge(dat.lca,dat.extra,all = TRUE)  
    
    

#------------------
# CALCUATE SUMS
#------------------ 

sums.byEquipment <- # sums for each piece of equipment, plus totals (e.g., x number of pieces),plus per year of service life
    dat.all%>%
    group_by(ID)%>%
    summarise(GWP.per.unit=sum(GWP),Lifespan=mean(Lifespan)) %>%
    mutate(Qty=c(2,1,2,2,3,2,1,1,1,1,2,1364,1,372,369),
           GWP.total=GWP.per.unit*Qty,
           GWP.per.yr.per.unit= GWP.per.unit/Lifespan)
        
    
 
sums.bySite <-  # sums by site, taking the totals of equipment at each site
    sums.byEquipment %>%
    mutate(GWP.total.per.year=GWP.total/Lifespan) %>%
    mutate (siteID = as.numeric(sub("^\\D*(\\d+).*$", "\\1", ID))) %>% #extract the number from the ID to get the site
    group_by(siteID) %>%  
    summarize(GWP.total=sum(GWP.total), # totals of equipment at each site
              GWP.total.per.year=sum(GWP.total.per.year)) # sums, but with weighted average annual embodied carbon using service life of equipment

 
sums.by.phase <- # which sections contribute most?
    dat.all %>%
    group_by(Section) %>%
    summarise(GWP=sum(GWP))


# Manually cateogize and add cost data for categories        
# We want to add a factor variable for the category of retrofit action, to enable grouping equipment together
# We have cost data by site and factor to add
sums.gwp<-
    sums.byEquipment %>%
    mutate(GWP.total.per.year=GWP.total/Lifespan) %>%
    mutate (siteID = as.numeric(sub("^\\D*(\\d+).*$", "\\1", ID))) %>% #extract the number from the ID to get the site %>%
    mutate(Percentage.of.GWP = GWP.total/sum(GWP.total)) %>%
    mutate(Retrofit.action = as.factor(case_when(
            grepl("ahu",ID) ~ "AHU",
            grepl("blr",ID)|grepl("pad",ID)|grepl("chm",ID)|grepl("suc",ID)|grepl("pum",ID) ~ "Boiler",
            grepl("ref",ID) ~ "Radiator",
            grepl("tstat",ID) ~ "Thermostat",
            grepl("mtr",ID) ~ "Heating"))) %>%
    group_by(siteID,Retrofit.action) %>%
    summarise(GWP.by.action.per.year=sum(GWP.total.per.year)) 
  
dat.for.plot<-
    reshape(sums.gwp, 
        direction = "long",
        varying = list(names(sums.gwp)[1:4]),
        v.names = "Value",
        idvar = c("GWP.by.action.per.year")
        #timevar = "Year",
       # times = 1950:1954)    

  nrow(sums.gwp) 
  
  mutate(Cost= c(476109,227801,4989,327035,970839,385398,246598,21358,337961))



dat.for.plot<-
    sums.gwp   

dat.for.plot<-merge(dat.for.plot,Cost)
     

# Visualize
    ggplot(sums.gwp, aes(x = siteID,
                         y=GWP.by.action.per.year,  
                         fill = Retrofit.action ) ) + 
    geom_bar( stat = "identity", position = "stack" ) +
    #coord_flip() +
    scale_fill_brewer( palette = "YlGnBu" ) +
    theme_minimal() + theme( legend.position = "bottom" )
 
   
  
    
    
 
    
```

